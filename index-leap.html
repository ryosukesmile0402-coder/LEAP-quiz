<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LEAP Quiz Mastery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Outfit:wght@300;600;900&display=swap');
        :root { --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg-gradient); color: #f8fafc; margin: 0; overflow: hidden; height: 100dvh; }
        #app { height: 100dvh; width: 100%; display: flex; flex-direction: column; position: relative; z-index: 10; }
        .bg-orb { position: absolute; width: 300px; height: 300px; border-radius: 50%; filter: blur(80px); z-index: 1; opacity: 0.3; animation: move 20s infinite alternate; }
        @keyframes move { from { transform: translate(-10%, -10%); } to { transform: translate(20%, 20%); } }
        .glass-card { background: rgba(255, 255, 255, 0.07); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 2rem; }
        .btn-primary { background: linear-gradient(135deg, #0ea5e9, #2563eb); color: white; font-weight: bold; box-shadow: 0 10px 20px -5px rgba(14, 165, 233, 0.4); }
        .choice-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); text-align: left; padding: 1.25rem; border-radius: 1.25rem; font-weight: bold; color: white; width: 100%; }
        .ans-correct { background: #10b981 !important; border-color: #10b981 !important; }
        .ans-wrong { background: #ef4444 !important; border-color: #ef4444 !important; }
        .rank-S { color: #fbbf24; text-shadow: 0 0 15px rgba(251, 191, 36, 0.5); }
        .rank-A { color: #f87171; }
        .rank-B { color: #60a5fa; }
        .rank-C { color: #fbbf24; }
        .rank-D { color: #4ade80; }
        .rank-E { color: #94a3b8; }
        .progress-ring__circle { transition: stroke-dashoffset 0.8s ease-in-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .produced-by { font-family: 'Outfit', sans-serif; font-size: 0.65rem; letter-spacing: 0.3em; color: rgba(255, 255, 255, 0.2); text-transform: uppercase; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div class="bg-orb bg-sky-500 top-[-50px] left-[-50px]"></div>
    <div class="bg-orb bg-indigo-600 bottom-[-50px] right-[-50px]"></div>
    <div id="app" class="max-w-md mx-auto"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCLn0SOd7xvuQ5Zd9IKsR71ugCw96m6Gsw",
  authDomain: "leap-test-9fe0b.firebaseapp.com",
  projectId: "leap-test-9fe0b",
  storageBucket: "leap-test-9fe0b.firebasestorage.app",
  messagingSenderId: "1047056215317",
  appId: "1:1047056215317:web:3ec726d8808a8ae0040d1c" // 更新済み
};

const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);

window.wordData = [
    {id:1, en:"follow", ja:"～に従う"},
    {id:2, en:"consider", ja:"～を考慮する"},
    {id:3, en:"increase", ja:"増える"}
];

const ADMIN_PASS = "Henly0402";
let state = { view: 'login', currentUser: null, users: [], quiz: null, quizType: null, rangeKey: "" };
const root = document.getElementById('app');

const getRankInfo = (score) => {
    if (score === 20) return { label: 'S', class: 'rank-S', order: 6 };
    if (score >= 18) return { label: 'A', class: 'rank-A', order: 5 };
    if (score >= 14) return { label: 'B', class: 'rank-B', order: 4 };
    if (score >= 10) return { label: 'C', class: 'rank-C', order: 3 };
    if (score >= 6)  return { label: 'D', class: 'rank-D', order: 2 };
    return { label: 'E', class: 'rank-E', order: 1 };
};

window.nav = (v, type = null) => { state.view = v; if (type) state.quizType = type; render(); };

window.adminLogin = () => {
    const p = prompt("ADMIN PASSを入力してください");
    if (p === ADMIN_PASS) { window.nav('admin'); } else if (p !== null) { alert("パスワードが違います"); }
};

window.login = () => {
    const id = document.getElementById('uID').value;
    const pw = document.getElementById('uPW').value;
    const u = state.users.find(x => x.id === id && x.pass === pw);
    if (u) { if (!u.bestRanks) u.bestRanks = {}; state.currentUser = u; window.nav('home'); }
    else { alert("IDまたはPasswordが正しくありません"); }
};

window.addUser = async () => {
    const id = document.getElementById('newID').value;
    const pw = document.getElementById('newPW').value;
    if(!id || !pw) return alert("IDとPassを入力してください");
    const newUser = { id, pass: pw, progress: 0, bestRanks: {} };
    try {
        await setDoc(doc(db, "users", id), newUser);
        state.users.push(newUser);
        alert("ユーザーを追加しました");
        render();
    } catch(e) { alert("保存に失敗しました"); }
};

window.startQuiz = (min, max) => {
    const pool = window.wordData.filter(w => w.id >= min && w.id <= max);
    state.rangeKey = `${state.quizType}_${min}_${max}`;
    const selected = [...pool].sort(() => Math.random() - 0.5).slice(0, 20);
    state.quiz = {
        questions: selected.map(item => {
            let choices = [item.ja]; 
            while (choices.length < 4) {
                const r = window.wordData[Math.floor(Math.random() * window.wordData.length)].ja;
                if (!choices.includes(r)) choices.push(r);
            }
            return { id: item.id, en: item.en, ja: item.ja, opts: choices.sort(() => Math.random() - 0.5) };
        }),
        curr: 0, score: 0
    };
    window.nav('quiz');
};

window.checkAns = async (idx) => {
    const q = state.quiz.questions[state.quiz.curr];
    const ok = (q.opts[idx] === q.ja);
    if (ok) {
        state.quiz.score++;
        if (state.quizType === 'Master') {
            state.currentUser.progress++;
            await setDoc(doc(db, "users", state.currentUser.id), state.currentUser);
        }
    }
    const btns = document.querySelectorAll('.choice-btn');
    btns.forEach((b, i) => {
        b.onclick = null;
        if (i === idx) b.classList.add(ok ? 'ans-correct' : 'ans-wrong');
        if (q.opts[i] === q.ja) b.classList.add('ans-correct');
    });
    setTimeout(() => {
        if (state.quiz.curr < state.quiz.questions.length - 1) { state.quiz.curr++; render(); } 
        else { handleQuizEnd(); }
    }, 800);
};

const handleQuizEnd = async () => {
    const rankInfo = getRankInfo(state.quiz.score);
    if (state.quizType !== 'Master') {
        const currentBest = state.currentUser.bestRanks[state.rangeKey] || { order: 0, label: '-' };
        if (rankInfo.order > currentBest.order) {
            state.currentUser.bestRanks[state.rangeKey] = { label: rankInfo.label, order: rankInfo.order };
            await setDoc(doc(db, "users", state.currentUser.id), state.currentUser);
        }
    }
    window.nav('result');
};

function render() {
    if (state.view === 'login') {
        root.innerHTML = `
            <div class="flex-1 flex flex-col justify-center p-8 fade-in">
                <div class="glass-card p-10 text-center relative">
                    <button onclick="window.adminLogin()" class="absolute top-6 left-1/2 -translate-x-1/2 text-[9px] text-white/30 border border-white/10 px-3 py-1 rounded-full uppercase tracking-widest z-50">Admin Access</button>
                    <h1 class="text-6xl font-black text-white mb-2 mt-4 italic tracking-tighter" style="font-family:'Outfit'">LEAP</h1>
                    <p class="text-[10px] text-sky-400 font-bold uppercase tracking-[0.3em] mb-8">Vocabulary Mastery</p>
                    <div class="space-y-4">
                        <input id="uID" type="text" placeholder="USER ID" class="w-full p-4 bg-white/5 rounded-2xl outline-none border border-white/10 text-white text-center">
                        <input id="uPW" type="password" placeholder="PASSWORD" class="w-full p-4 bg-white/5 rounded-2xl outline-none border border-white/10 text-white text-center">
                        <button onclick="window.login()" class="w-full py-4 btn-primary rounded-2xl text-lg uppercase tracking-widest font-black">Enter</button>
                    </div>
                </div>
            </div>
            <div class="pb-8 text-center produced-by">Produced by Henly</div>`;
    } 
    else if (state.view === 'home') {
        root.innerHTML = `
            <div class="p-8 flex-1 flex flex-col fade-in">
                <div class="flex justify-between items-start mb-10">
                    <div><p class="text-[10px] text-sky-400 font-bold uppercase tracking-widest">Authorized Student</p><h2 class="text-4xl font-black text-white" style="font-family:'Outfit'">${state.currentUser.id}</h2></div>
                </div>
                <div class="space-y-4 flex-1">
                    <button onclick="window.nav('range', 'Basic')" class="w-full py-8 glass-card text-left px-8 relative border-l-4 border-l-sky-500"><span class="block text-[10px] text-sky-400 font-bold mb-1 uppercase tracking-widest">Stage 01</span><span class="text-2xl font-black text-white">BASIC</span></button>
                    <button onclick="window.nav('range', 'Standard')" class="w-full py-8 glass-card text-left px-8 relative border-l-4 border-l-indigo-500"><span class="block text-[10px] text-indigo-400 font-bold mb-1 uppercase tracking-widest">Stage 02</span><span class="text-2xl font-black text-white">STANDARD</span></button>
                    <button onclick="window.nav('range', 'Master')" class="w-full py-8 glass-card text-left px-8 relative border-l-4 border-l-amber-500"><span class="block text-[10px] text-amber-500 font-bold mb-1 uppercase tracking-widest">Stage 03</span><span class="text-2xl font-black text-white">MASTER</span></button>
                </div>
                <button onclick="location.reload()" class="mt-4 py-2 text-white/20 text-xs font-bold uppercase tracking-widest">Logout</button>
            </div>
            <div class="pb-8 text-center produced-by">Produced by Henly</div>`;
    } 
    else if (state.view === 'range') {
        if (state.quizType === 'Master') {
            const total = 2000; const progress = state.currentUser.progress || 0; const percent = Math.min((progress / total) * 100, 100);
            const radius = 70; const circum = 2 * Math.PI * radius; const offset = circum - (percent / 100 * circum);
            root.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center p-8 fade-in"><div class="relative mb-10 flex items-center justify-center"><svg width="200" height="200"><circle class="text-white/5" stroke="currentColor" stroke-width="12" fill="transparent" r="${radius}" cx="100" cy="100"/><circle class="progress-ring__circle text-amber-500" stroke="currentColor" stroke-width="12" stroke-linecap="round" fill="transparent" r="${radius}" cx="100" cy="100" style="stroke-dasharray: ${circum} ${circum}; stroke-dashoffset: ${offset}"/></svg><div class="absolute inset-0 flex flex-col items-center justify-center text-center"><span class="text-3xl font-black text-white">${progress}</span><span class="text-[10px] text-white/30 uppercase font-bold border-t border-white/10 mt-1 pt-1">of ${total} words</span></div></div><button onclick="window.startQuiz(1, 2027)" class="w-full py-6 btn-primary rounded-3xl font-black text-2xl uppercase tracking-widest">Start Test</button><button onclick="window.nav('home')" class="mt-8 text-white/30 font-bold uppercase tracking-widest text-xs">Back</button></div>`;
        } else {
            let step = (state.quizType === 'Basic') ? 100 : 400; let btns = "";
            for (let i = 1; i <= 2000; i += step) {
                const key = `${state.quizType}_${i}_${i+step-1}`; const best = state.currentUser.bestRanks[key] || { label: '-' };
                btns += `<button onclick="window.startQuiz(${i}, ${i+step-1})" class="w-full p-6 glass-card flex justify-between items-center"><span class="font-bold text-white/80">${i} — ${i+step-1}</span><span class="text-2xl font-black rank-${best.label}">${best.label}</span></button>`;
            }
            root.innerHTML = `<div class="p-8 flex-1 flex flex-col fade-in overflow-hidden"><h2 class="text-2xl font-black mb-6 text-white uppercase">${state.quizType}</h2><div class="flex-1 space-y-3 overflow-y-auto scrollbar-hide pb-10">${btns}</div><button onclick="window.nav('home')" class="py-4 text-white/30 font-bold text-xs uppercase text-center">Back</button></div>`;
        }
    } 
    else if (state.view === 'quiz') {
        const q = state.quiz.questions[state.quiz.curr];
        root.innerHTML = `<div class="flex-1 flex flex-col p-6 fade-in"><div class="w-full h-1 bg-white/5 rounded-full mt-4 overflow-hidden"><div class="h-full bg-sky-500 transition-all duration-500" style="width:${((state.quiz.curr+1)/20)*100}%"></div></div><div class="flex-1 flex flex-col justify-center items-center text-center px-4"><span class="text-[9px] font-bold text-sky-400 mb-2 uppercase tracking-[0.3em]">No.${q.id}</span><h2 class="text-5xl font-black text-white leading-tight" style="font-family:'Outfit'">${q.en}</h2></div><div class="grid gap-3 mb-10">${q.opts.map((o, i) => `<button onclick="window.checkAns(${i})" class="choice-btn">${o}</button>`).join('')}</div></div>`;
    } 
    else if (state.view === 'result') {
        const rank = getRankInfo(state.quiz.score);
        root.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center p-8 fade-in"><div class="glass-card w-full py-16 text-center relative overflow-hidden"><div class="text-[10px] font-bold text-white/30 uppercase tracking-[0.4em] mb-2">Result Rank</div><div class="text-[10rem] font-black leading-none ${rank.class} mb-4" style="font-family:'Outfit'">${rank.label}</div><div class="text-3xl font-black text-white/90 mb-12">${state.quiz.score} <span class="text-lg text-white/20 font-normal">/ 20</span></div><button onclick="window.nav('home')" class="w-3/4 mx-auto py-4 btn-primary rounded-2xl font-black uppercase tracking-widest">Continue</button></div></div>`;
    }
    else if (state.view === 'admin') {
        root.innerHTML = `<div class="p-8 flex-1 flex flex-col fade-in text-white"><h2 class="text-2xl font-bold mb-6 italic" style="font-family:'Outfit'">Administrator</h2><div class="glass-card p-6 mb-6 space-y-4"><p class="text-[10px] font-bold text-sky-400 uppercase tracking-widest">New Student</p><input id="newID" type="text" placeholder="ID" class="w-full p-3 bg-white/5 rounded-xl border border-white/10"><input id="newPW" type="text" placeholder="Pass" class="w-full p-3 bg-white/5 rounded-xl border border-white/10"><button onclick="window.addUser()" class="w-full py-3 btn-primary rounded-xl font-bold">Add User</button></div><div class="flex-1 overflow-auto bg-white/5 rounded-3xl p-4 shadow-inner mb-6 scrollbar-hide text-sm">${state.users.map(u => `<div class="flex justify-between items-center p-4 border-b border-white/5"><div><p class="font-bold">${u.id}</p><p class="text-[10px] text-white/30 font-mono">PW: ${u.pass}</p></div><span class="text-sky-500 font-bold">${u.progress}pt</span></div>`).join('')}</div><button onclick="window.nav('login')" class="py-4 text-white/30 font-bold text-xs text-center uppercase tracking-widest">Exit Admin</button></div>`;
    }
}

(async () => {
    try {
        const snap = await getDocs(collection(db, "users"));
        state.users = snap.docs.map(d => d.data());
        render();
    } catch (e) { console.error(e); }
})();
render();
</script>
</body>
</html>
